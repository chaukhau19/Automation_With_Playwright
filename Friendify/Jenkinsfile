pipeline {
    agent any
    environment {
        // Github repository information
        GITHUB_URL = 'https://github.com/chaukhau19/Automation_With_Playwright.git'  
        REPO_NAME = 'Friendify'  
        SERVER_PATH = "Automation_With_Playwright/${REPO_NAME}"  
        BRANCH_NAME = 'master'  
        
        // Jenkins Credentials (sử dụng Jenkins Credentials Plugin với ID)
        JENKINS_CREDENTIALS_ID = 'jenkins-ssh-credentials'  // ID của SSH credentials lưu trữ trong Jenkins
        JENKINS_USERNAME = 'khauntc'  
        JENKINS_PASSWORD = 'KhauNTC123!@#' 
        JENKINS_ADDRESS = 'https://jenkins.playgroundvina.com/'
        COMMANDS_WIN = './FD_Auto.bat'
        COMMANDS_UNIX = './FD_Auto.sh'  // Nếu bạn có script bash cho Linux/macOS
        ENVIRONMENT = 'windows'  // Cập nhật giá trị này thành 'windows', 'linux' hoặc 'macos' tùy theo môi trường
    }
    
    stages {
        // Stage CI: Checkout code từ repository GitHub
        stage('CI: Checkout code') {
            steps {
                // Tải code từ nhánh 'master' của GitHub
                git branch: "${BRANCH_NAME}", url: "${GITHUB_URL}"
            }
        }
        
        // Stage CD: Deploy code lên server
        stage('CD: Deploying...') {
            when {
                anyOf {
                    branch 'master'  // Chạy deploy nếu nhánh là 'master'
                    branch 'main'    // Hoặc là 'main'
                }
            }
            // FOR USERNAME/PASSWORD
            steps {
                dir("${SERVER_PATH}") {
                    script {
                        echo "Deploying to '${BRANCH_NAME}'..."
                        if (ENVIRONMENT == 'windows') {
                            bat 'git pull --rebase'  // Sử dụng bat thay vì sh cho Windows
                            bat "plink.exe -pw ${JENKINS_PASSWORD} ${JENKINS_USERNAME}@${JENKINS_ADDRESS} '${COMMANDS_WIN}'"
                        } else {
                            sh 'git pull --rebase'  // Sử dụng sh cho Linux/macOS
                            if (ENVIRONMENT == 'linux' || ENVIRONMENT == 'macos') {
                                sh "sshpass -p '${JENKINS_PASSWORD}' ssh -o StrictHostKeyChecking=no ${JENKINS_USERNAME}@${JENKINS_ADDRESS} '${COMMANDS_UNIX}'"
                            }
                        }
                    }
                }
            }
            // FOR JENKINS_CREDENTIALS_ID
            // steps {
            //     dir("${SERVER_PATH}") {
            //         script {
            //             echo "Deploying to '${BRANCH_NAME}'..."
            //             if (ENVIRONMENT == 'windows') {
            //                 bat 'git pull --rebase'  // Sử dụng bat thay vì sh cho Windows
            //                 bat "plink.exe -pw ${JENKINS_PASSWORD} ${JENKINS_USERNAME}@${JENKINS_ADDRESS} '${COMMANDS_WIN}'"
            //             } else {
            //                 // Sử dụng ssh-agent với SSH key từ Jenkins Credentials
            //                 sshagent (credentials: [JENKINS_CREDENTIALS_ID]) {
            //                     sh 'git pull --rebase'  // Cập nhật code với git pull --rebase
            //                     if (ENVIRONMENT == 'linux' || ENVIRONMENT == 'macos') {
            //                         // Thực hiện deploy với lệnh make và các biến repo_name và branch_name
            //                         sh "sudo make deploy repo_name=${REPO_NAME} branch_name=${BRANCH_NAME}"
            //                         // Kết nối SSH và thực thi lệnh từ Jenkins
            //                         sh "ssh -o StrictHostKeyChecking=no ${JENKINS_USERNAME}@${JENKINS_ADDRESS} '${COMMANDS_UNIX}'"
            //                     }
            //                 }
            //             }
            //         }
            //     }
            // }
        }
    }
    
    post {
        always {
            script {
                def status = currentBuild.result ?: 'SUCCESS'
                echo "Build status: ${status}"
                if (ENVIRONMENT == 'windows') {
                    bat "del /q .\\* .\\.??*"
                } else {
                    sh "rm -rf ./* ./.??*"
                }
            }
        }
    }
}
